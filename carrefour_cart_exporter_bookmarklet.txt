javascript:(function(){function e(){if(!window.location.href.includes("/cart"))return alert("יש להפעיל את הסקריפט מתוך עמוד העגלה"),null;let e=n("retailerId");return e||(e="1540"),new Promise(t=>{let r=null;if(window.performance&&window.performance.getEntries){const t=window.performance.getEntries();for(let o of t)if(o.name&&"string"==typeof o.name&&o.name.includes("/v2/retailers/")&&o.name.includes("/carts/")){const t=new URL(o.name),n=t.pathname.split("/");r={url:o.name,retailerId:n[3],branchId:n[5],cartId:n[7].split("?")[0],appId:t.searchParams.get("appId")||"4"};break}}if(!r&&window.location.href.includes("/cart"))try{let t="";const o=document.querySelectorAll("[data-cart-id]");if(o.length>0&&(t=o[0].getAttribute("data-cart-id")),!t){const e=document.querySelectorAll("script");for(let r of e){const e=r.textContent||"",o=e.match(/cartId['":\s]+([0-9]+)/);if(o&&o[1]){t=o[1];break}}}t&&(r={retailerId:e,branchId:"2992",cartId:t,appId:"4"})}catch(e){console.error("שגיאה בחילוץ פרטי העגלה:",e)}r||(r={retailerId:"1540",branchId:"2992",cartId:"78696291",appId:"4"},console.log("משתמש בערכי ברירת מחדל עבור API העגלה:",r)),t(r)})}function t(){return new Promise(e=>{const t="a01c3ac7923bf509a3b76e5d034b30ba3a2fa9b61e38817c5c4dc520cd833be414c9917d574d0793c61f22b8ff8a2d87c85ea6c4cdc3d42c5e4996bff204f68b";let r="";if(window.localStorage){const e=window.localStorage.getItem("carrefour_auth_token");e&&(r=e)}if(!r)try{const e=document.querySelectorAll("script:not([src])");for(let t of e){const e=t.textContent||"",o=e.match(/Bearer\s+([a-zA-Z0-9]{40,})/),n=e.match(/token['":\s]+(["']?)([a-zA-Z0-9]{40,})\1/),a=e.match(/authorization['":\s]+(["']?)Bearer\s+([a-zA-Z0-9]{40,})\1/i);if(o&&o[1]){r=o[1];break}if(n&&n[2]){r=n[2];break}if(a&&a[2]){r=a[2];break}}}catch(e){console.error("שגיאה בחיפוש הטוקן בסקריפטים:",e)}if(!r&&window.localStorage)for(let e of["auth_token","token","authToken","accessToken","userToken","jwt"])try{const t=window.localStorage.getItem(e);if(t&&t.length>40){r=t.replace(/^Bearer\s+/i,"");break}}catch(e){}if(!r&&window.localStorage)try{for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e),o=localStorage.getItem(t);if(o&&"string"==typeof o&&o.length>40&&/^[a-zA-Z0-9]{40,}$/.test(o)){r=o;break}}}catch(e){console.error("שגיאה בסריקת localStorage:",e)}if(!r)try{const e=document.querySelectorAll("[data-token], [data-auth]");for(let t of e){const e=t.getAttribute("data-token"),o=t.getAttribute("data-auth");if(e&&e.length>40){r=e;break}if(o&&o.length>40){r=o;break}}}catch(e){console.error("שגיאה בחיפוש הטוקן באלמנטים:",e)}r||(console.log("משתמש בטוקן ברירת מחדל"),r=t),r&&window.localStorage&&window.localStorage.setItem("carrefour_auth_token",r),e(r)})}function r(e="ייצא לקובץ CSV"){const t=document.getElementById("carrefour-export-csv");t&&(t.disabled=!1,t.textContent=e,t.style.backgroundColor="#f39200")}function o(){try{if(document.getElementById("carrefour-export-csv"))return;const e=document.createElement("button");e.id="carrefour-export-csv",e.textContent="ייצא לקובץ CSV",e.style.position="fixed",e.style.top="10px",e.style.right="10px",e.style.zIndex="9999",e.style.padding="10px 15px",e.style.backgroundColor="#f39200",e.style.color="white",e.style.border="none",e.style.borderRadius="4px",e.style.cursor="pointer",e.style.fontWeight="bold",e.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",e.addEventListener("mouseenter",function(){this.style.backgroundColor="#e58a00"}),e.addEventListener("mouseleave",function(){this.style.backgroundColor="#f39200"}),document.body.appendChild(e),e.addEventListener("click",a)}catch(e){console.error("שגיאה ביצירת כפתור:",e)}}function n(e){const t=`; ${document.cookie}`,r=t.split(`; ${e}=`);return 2===r.length?r.pop().split(";").shift():null}async function a(){try{const o=document.getElementById("carrefour-export-csv");o&&(o.disabled=!0,o.textContent="טוען...",o.style.backgroundColor="#aaa");const n=await e();if(!n)return alert("לא הצלחנו לאתר את פרטי העגלה"),void r();const a=await t();if(!a)return alert("נדרש טוקן אימות כדי להמשיך"),void r();const i=`https://www.carrefour.co.il/v2/retailers/${n.retailerId}/branches/${n.branchId}/carts/${n.cartId}?appId=${n.appId}`;console.log("שולח בקשה ל-API:",i),console.log("עם טוקן:",a.substring(0,10)+"...");const s=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json;charset=UTF-8",Authorization:`Bearer ${a}`,Accept:"application/json, text/plain, */*","X-HTTP-Method-Override":"PATCH"},credentials:"include",body:JSON.stringify({})});if(!s.ok)throw new Error(`שגיאת API: ${s.status} ${s.statusText}`);const c=await s.json(),l=c.cart.lines;if(!l||0===l.length)return alert("העגלה ריקה או שלא התקבל מידע"),void r();const d=l.filter(e=>!e.text.includes("איסוף עצמי")).map(e=>({שם:e.text,ברקוד:e.barcode,כמות:e.quantity,מחיר:e.unitPrice,"סה\"כ":e.totalPrice,קישור:`https://www.carrefour.co.il/?catalogProduct=${e.product?.productId??""}`}));console.table(d);const p=Object.keys(d[0]).join(","),u=d.map(e=>Object.values(e).map(e=>`"${String(e).replace(/"/g,'""')}"`).join(",")),g=[p,...u].join("\n"),h=new Blob(["\ufeff"+g],{type:"text/csv;charset=utf-8;"}),m=document.createElement("a");m.href=URL.createObjectURL(h),m.download="carrefour_products.csv",document.body.appendChild(m),m.click(),document.body.removeChild(m),r("ייצוא הושלם!"),setTimeout(()=>{r()},2e3)}catch(e){console.error("שגיאה:",e),alert(`שגיאה: ${e.message}`),r()}}o()})(); 